{% extends "base.html" %}


{% block app_content %}
<!-- Include page-specific scripts at the beginning of each page -->
<script src="static/scripts/devices/addDevice.js"></script>
<script src="static/scripts/devices/updateDevice.js"></script>
<script src="static/scripts/devices/deleteDevice.js"></script>
<script src="static/scripts/devices/displayForm.js"></script>
<script src="static/scripts/devices/hideForm.js"></script>
<script src="static/scripts/devices/populateDeviceTable.js"></script>

<!-- Main Content -->
<div class="main">
    <h1>Device Configuration</h1>

    <!-- Table showing a summary of the devices configured for use with the system -->
    <table class="table table-bordered" id="devices_table"></table>

    <!-- Linebreaks to move button onto new line -->
    <br>

    <!-- Create a form to hold the device management options -->

    <!-- Create a div to hold the form -->
    <div id="devConfig" class="background">

        <!-- Create the form to trigger the javascript update device function -->
        <form class="bg-content animate" action="#" onsubmit="devicesConfigChange(this)">

            <div id="devConfigContainer" class="container">
            </div>
            <!-- <div class="container">
          <button type="button" onclick="hideForm()">Cancel</button>
        </div> -->
        </form>
    </div>


    <!-- Device options -->
    <button class="btn btn-secondary" onclick="location.href='{{ url_for('adddevice') }}'">Add a device</button>
    <button class="btn btn-secondary" onclick="updateDevice()">Update a device</button>
    <button class="btn btn-secondary" onclick="deleteDevice()">Delete a device</button>

    <!-- Script to close the popup form when anywhere outside it is clicked -->
    <script>
        // Get the id of the background div
        var modal = document.getElementById('devConfig');

        // When the user clicks anywhere outside of the popup
        window.onclick = function (event) {
            if (event.target == modal) {

                //Hide the form popup
                hideForm()
            }
        }
    </script>
    <script>

        //Form object submitted
        function devicesConfigChange(formObject) {

            //Display form element
            //alert("Form Submitted");

            //Display Data from form - use hidden input to get 
            //alert(formObject.opType.value);

            //Hide the form
            hideForm();
        }

        //When the web page has loaded and the the document is ready to be worked on
        $(document).ready(function () {

            //Populate the device table with the devices on the system
            let attDevT = populateDeviceTable("devices_table");

            //Check if failed - code non-zero
            if (attDevT.code) {
                //Alert that an error occurred
                alert("Error populating devices");

                //Log specific error
                console.log(attDevT.msg);

                //Break
                return false;

            }

            //Bind the test buttons to the following handler if table population succeeded
            $(document).on("click", "button.btnTest", function (event) {

                //Debugging, display the ID to be requested
                //alert(event.target.id);

                var state = 0;

                if (confirm("Ok for on, cancel for off!")) {
                    state = 1;
                } else {
                    state = 0;
                }

                //Define the URL to hit
                var reqURL = '/devicetest/id=' + event.target.id + 'state=' + state;

                //Debuging, dislay the URL to send a GET request to
                //alert(reqURL);

                //Send the AJAX request to the defined URL
                $.ajax({
                    type: "GET",
                    url: reqURL,
                    //On success, alert the user
                    success: function (result) {
                        //alert('ok');
                    },
                    //On failure, alert the user
                    error: function (result) {
                        //alert('error');
                    }
                });
            });
        });
    </script>
</div>
{% endblock %}