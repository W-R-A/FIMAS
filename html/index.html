<!doctype html>
<html lang="en-GB">

<head>
    <!-- Declare charset used at UTF-8 -->
    <meta charset="UTF-8">

    <!-- Title of the webpage -->
    <title>FIMAS Main Page</title>

    <!-- Link to stylesheet -->
    <link rel="stylesheet" type="text/css" href="styles.css">

    <!-- Set initial scale for devices with smaller screens -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

</head>

<body>
    <header>
        <ul>
            <li><a class="active" href="index.html">Home</a></li>
            <li><a href="deviceConfig.html">Device Configuration</a></li>
            <li><a href="routines.html">Routines Configuration</a></li>
            <li><a href="help.html">Help</a></li>
        </ul>
    </header>

    <div class="main">
        <h1>Welcome</h1>

        <p>Select a routine to run</p>

        <!-- Dropdown to select the routine to run -->
        <select id="routines_dropdown">
        </select>

        <!-- Test the devices used in the routine -->
        <button class="btnTstDevices">Test Devices</button>

        <!-- Run the Routine -->
        <button class="btnRunRoutine">Run the Routine</button>

    </div>
    <script src="jquery.js"></script>
    <script>
        //Declare the populate routines function - This will popuate the routines dropdown based on the routines.json file
        function populateRoutines() {

            //Ensure that the dropdown is empty
            $('#routines_dropdown').empty();

            //Set default option as select device, and make it disabled
            $('#routines_dropdown').append('<option selected="true" disabled>Select Routine</option>');
            $('#routines_dropdown').prop('selectedIndex', 0);

            //Define some temporary variables to hold the HTML
            var opHTML = '';

            //Testing the parsing of the json
            var jsonData = "[{\"routineID\":\"1004\",\"name\":\"AlCl\",\"timings\":[{\"devID\":\"1000\",\"timeStart\":\"0\",\"timeStop\":\"4\",\"state\":\"1\"},{\"devID\":\"1000\",\"timeStart\":\"4\",\"timeStop\":\"9\",\"state\":\"0\"},{\"devID\":\"1000\",\"timeStart\":\"9\",\"timeStop\":\"15\",\"state\":\"1\"},{\"devID\":\"1001\",\"timeStart\":\"0\",\"timeStop\":\"6\",\"state\":\"0\"},{\"devID\":\"1001\",\"timeStart\":\"6\",\"timeStop\":\"8\",\"state\":\"1\"},{\"devID\":\"1001\",\"timeStart\":\"8\",\"timeStop\":\"15\",\"state\":\"0\"},{\"devID\":\"1002\",\"timeStart\":\"0\",\"timeStop\":\"3\",\"state\":\"1\"},{\"devID\":\"1002\",\"timeStart\":\"3\",\"timeStop\":\"7\",\"state\":\"0\"},{\"devID\":\"1002\",\"timeStart\":\"7\",\"timeStop\":\"15\",\"state\":\"1\"}]},{\"name\":\"CuSO4\",\"timings\":[{\"devID\":\"1000\",\"timeStart\":\"0\",\"timeStop\":\"4\",\"state\":\"1\"},{\"devID\":\"1000\",\"timeStart\":\"4\",\"timeStop\":\"9\",\"state\":\"0\"},{\"devID\":\"1000\",\"timeStart\":\"9\",\"timeStop\":\"15\",\"state\":\"1\"},{\"devID\":\"1001\",\"timeStart\":\"0\",\"timeStop\":\"6\",\"state\":\"0\"},{\"devID\":\"1001\",\"timeStart\":\"6\",\"timeStop\":\"8\",\"state\":\"1\"},{\"devID\":\"1001\",\"timeStart\":\"8\",\"timeStop\":\"15\",\"state\":\"0\"},{\"devID\":\"1002\",\"timeStart\":\"0\",\"timeStop\":\"3\",\"state\":\"1\"},{\"devID\":\"1002\",\"timeStart\":\"3\",\"timeStop\":\"7\",\"state\":\"0\"},{\"devID\":\"1002\",\"timeStart\":\"7\",\"timeStop\":\"15\",\"state\":\"1\"}]}]";

            //Testing - use static json
            response = $.parseJSON(jsonData)

            //Get the devices on the system in a JSON format
            //$.getJSON("/devices.json", function (response) {
            //Loop through the response and fill in the table and dropdown
            $.each(response, function (i, item) {
                //Generate the dropdown html
                opHTML += '<option class=' + item.routineID + '>' + item.name + '</option>';
            });

            //Append the html to the dropdown
            $('#routines_dropdown').append(opHTML);
            //});
        }
    </script>
    <script>
        //When the webpage has loaded and the the document is ready to be worked on
        $(document).ready(function () {
            //Populate the routines dropdown
            populateRoutines()

            //Bind the test button to the following handler
            $(document).on("click", "button.btnTstDevices", function (event) {

                //Get the ID of the selected routine
                var routineID = $('select[id="routines_dropdown"] option:selected').attr('class');

                //Check if a valid routine has been selected
                if (typeof routineID == "undefined") {
                    //Tell the user to select a valid device
                    alert("Please select a routine, or create one if none are available");
                    //Return and do not execute the rest of the function as there is an invalid input
                    return 0;
                }

                //Define the URL to hit
                var reqURL = '/testdevices/routineid=' + routineID;

                //Debuging, dislay the URL to send a GET request to
                //alert(reqURL);

                //Send the AJAX request to the defined URL
                $.ajax({
                    type: "GET",
                    url: reqURL,
                    //On success, alert the user
                    success: function (result) {
                        //alert('ok');
                    },
                    //On failure, alert the user
                    error: function (result) {
                        alert('An error occured testing the devices');
                    }
                });
            });
        });
    </script>
</body>

</html>