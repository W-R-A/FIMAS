<!doctype html>
<html lang="en-GB">

<head>
  <!-- Declare charset used at UTF-8 -->
  <meta charset="UTF-8">

  <!-- Title of the webpage -->
  <title>FIMAS Routines Configuration</title>

  <!-- Link to stylesheet -->
  <link rel="stylesheet" type="text/css" href="styles.css">

  <!-- Set initial scale for devices with smaller screens -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>
  <!-- Header Navigation Bar -->
  <header>
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="deviceConfig.html">Device Configuration</a></li>
      <li><a class="active" href="routines.html">Routines Configuration</a></li>
      <li><a href="help.html">Help</a></li>
    </ul>
  </header>

  <!-- Main Content -->
  <div class="main">
    <h1>Routines Configuration</h1>

    <p>Select Device: </p>

    <!-- Dropdown to edit the configuration of a device -->
    <select id="devices_dropdown">
    </select>

    <!-- Create an input box for the timings, and restrict its contents to a number between 0 and 1000 -->
    <input id="timeStart" type="number" min="0" , max="1000"></input>

    <!-- Create an input box for the timings, and restrict its contents to a number between 0 and 1000 -->
    <input id="timeStop" type="number" min="0" , max="1000"></input>


    <select id="state">
      <option selected="true" disabled>Select State</option>
    </select>

    <button class="genTiming">Generate Timings</button>

    <div id="timings"></div>


    <script src="jquery.js"></script>
    <script>
      $(document).ready(function () {
        // Your code here.
        //Document is ready to be manipulated

        var globalTimings = [];

        //Get user input values
        //No paraeters need to be passed
        //Return key values pairs of the user input data
        function getInputs() {

          //Get the device ID
          var devID = $('select[id="devices_dropdown"] option:selected').attr('id');

          //Get the time from the input box
          var time = $("#timeStart").val();
          var time = $("#timeStop").val();

          //Get the device state
          var devState = $('select[id="state"] option:selected').attr('class');

          //Return values
          return {
            devID: devID,
            time: time,
            devState: devState,
          };

        }


        function checkInputs(values) {

          //Check if a valid device selected
          if (typeof values.devID == "undefined") {
            //Tell the user to select a valid device
            alert("Please select a device");
            //Return and do not execute the rest of the function as there is an invalid input
            return 0;
          }

          //Check the time value - should only be a integer between 0 and 1000
          if ((values.time < 0) || (values.time > 1000)) {
            //Alert the user to select a valid time
            alert("Please enter a time between 0 and 1000 seconds");

            //Return and do not execute the rest of the function as there is an invalid input
            return 0;
          }


          var devState = $('select[id="state"] option:selected').attr('class');



          return 1;
        }


        //Generate timing JSON data from user input
        $(document).on("click", "button.genTiming", function (event) {

          //Get the value of the user inputs
          values = getInputs();

          //Check that the user input is valid
          if (checkInputs(values)) {

            //Create the JSON object
            var obj = { devID: values.devID, time: values.time, state: values.devState };

            //Convert the JSON object to a string
            var myJSON = JSON.stringify(obj);

            globalTimings.push(myJSON);

            //Append this to the page
            $('<p>' + myJSON + '</p>').appendTo('#timings');

            console.log(globalTimings);
          }
        });




        //Bind the device selection to the following handler - to adjust the state drop down
        $(document).on("change", "#devices_dropdown", function (event) {

          var devClass = $('select[id="devices_dropdown"] option:selected').attr('class');

          //Debugging, display the ID to be requested
          //alert($('select[id="devices_dropdown"] option:selected').attr('class'));

          $('#state').empty();

          switch (devClass) {
            case "perPump":
              $('#state').append('<option selected="true" disabled>Select State</option>');
              $('#state').append('<option class="stateOn">On</option>');
              $('#state').append('<option class="stateOff">Off</option>');
              $('#state').prop('selectedIndex', 0);
              break;

            case "solValve":
              $('#state').append('<option selected="true" disabled>Select State</option>');
              $('#state').append('<option class="stateOn">On</option>');
              $('#state').append('<option class="stateOff">Off</option>');
              $('#state').prop('selectedIndex', 0);
              break;

            case "sixValve":
              $('#state').append('<option selected="true" disabled>Select State</option>');
              $('#state').append('<option class="stateA">Position A</option>');
              $('#state').append('<option class="stateB">Position B</option>');
              $('#state').prop('selectedIndex', 0);
              break;

            default:
            // code block
          }
        });

        //alert('Loading Devices Configuration');

        //Clear dropdown
        $('#devices_dropdown').empty();

        //Set default option as select device, and make it disabled
        $('#devices_dropdown').append('<option selected="true" disabled>Select Device</option>');
        $('#devices_dropdown').prop('selectedIndex', 0);

        var opHTML = '';

        var jsonData = "[{\"devID\":\"1000\",\"devName\":\"Sample Pump\",\"devType\":\"perPump\",\"devPin1\":\"1\",\"devPin2\":\"-1\"},{\"devID\":\"1001\",\"devName\":\"Control Valve\",\"devType\":\"solValve\",\"devPin1\":\"2\",\"devPin2\":\"-1\"},{\"devID\":\"1002\",\"devName\":\"6-Port Valve\",\"devType\":\"sixValve\",\"devPin1\":\"3\",\"devPin2\":\"4\"}]";

        response = $.parseJSON(jsonData)
        $.each(response, function (i, item) {
          opHTML += '<option id=' + item.devID + ' class =' + item.devType + '>' + item.devName + '</option>';
        });

        $('#devices_dropdown').append(opHTML);
      });
    </script>

  </div>
</body>

</html>