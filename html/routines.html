<!doctype html>
<html lang="en-GB">

<head>
  <!-- Declare charset used at UTF-8 -->
  <meta charset="UTF-8">

  <!-- Title of the webpage -->
  <title>FIMAS Routines Configuration</title>

  <!-- Link to stylesheet -->
  <link rel="stylesheet" type="text/css" href="styles.css">

  <!-- Set initial scale for devices with smaller screens -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>
  <!-- Header Navigation Bar -->
  <header>
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="deviceConfig.html">Device Configuration</a></li>
      <li><a class="active" href="routines.html">Routines Configuration</a></li>
      <li><a href="help.html">Help</a></li>
    </ul>
  </header>

  <!-- Main Content -->
  <div class="main">
    <h1>Routines Configuration</h1>

    <p>Select a routine to configure</p>
    <!-- Dropdown to select the routine to configure -->
    <select id="routines_dropdown"></select>

    <p>Select Device: </p>

    <!-- Dropdown to edit the configuration of a device -->
    <select id="devices_dropdown" title="Select a device"></select>

    <!-- Create an input box for the timings, and restrict its contents to a number between 0 and 1000 -->
    <input id="timeStart" type="number" min="0" , max="1000" title="The starting time for the step"></input>

    <!-- Create an input box for the timings, and restrict its contents to a number between 0 and 1000 -->
    <input id="timeStop" type="number" min="0" , max="1000" title="The ending time for the step"></input>

    <!-- Create a dropdown to select the state of the devices during a step -->
    <select id="state" title="Select the state of the device during the step"></select>

    <!-- Create a button to generate the timing data -->
    <button class="genTiming">Generate Timings</button>

    <!-- Linebreaks to move the figure down -->
    <br>
    <br>

    <!-- Create a figure to hold the timing visualisation -->
    <figure>
      <!-- Create a div for the graphic bars to visualise timing -->
      <div id="visualisation" class="graphic">
      </div>
    </figure>

    <script src="functions.js"></script>
    <script src="jquery.js"></script>

    <script>
      $(document).ready(function () {
        // Your code here.
        //Document is ready to be manipulated

        //Populate the routines dropdown
        var attRou = populateRoutines("routines_dropdown");

        //Check if failed - code non-zero
        if (attRou.code) {
          //Alert that an error occurred
          alert("Error populating routines");

          //Log specific error
          console.log(attRou.msg);
        }


        var routines = [];

        //Get user input values
        //No parameters need to be passed
        //Return key values pairs of the user input data
        function getInputs() {

          //Get the device ID
          var devID = $('select[id="devices_dropdown"] option:selected').attr('id');

          //Get the time from the input box
          var timeStart = $("#timeStart").val();
          var timeStop = $("#timeStop").val();

          //Get the device state
          var devState = $('select[id="state"] option:selected').attr('class');

          //Return values
          return {
            devID: devID,
            timeStart: timeStart,
            timeStop: timeStop,
            devState: devState,
          };
        }

        function checkSingleSanity(newValue, existingValue) {
          //Is the ID the same
          if (values.devID == existingValue.devID) {

            //Are the start time within the existing value 
            if ((values.timeStart > existingValue.timeStart && values.timeStart < existingValue.timeStop)) {
              //Are the stop time within the existing value 
              if ((values.timeStop > existingValue.timeStart && values.timeStop < existingValue.timeStop)) {
                //Timings are within previous range, alert user
                alert("Timings overlap previous inputs, aborting");
                return 0;
              }
              else {
                //No overlap, safe to proceed,
                return 1;
              }

              //Is the state the same
              if (values.devState = existingValue.devState) {
                //If yes, are the start and stop times the same or do they need to be changed

              }
              //If no check timings
              else {


              }
            }
            //Different device, no worries
            else {

            }
          }
          else {
            //Different ID, safe to proceed
            return 1;
          }
        }

        //Check if the inputs are sane - not conflicting with other inputs
        function checkInputsSanity(values) {
          //Loop through all of the previous timing data and raise an error if the new data would conflict with the existing data
          //ie if the states are different for the same time - gaps of undefined time 

          //Conflict detection
          //Start
          //Check if ID is the same
          //Check if the start time is within the previous range
          //Check if the stop time is within the previous range
          //Check if the state is the same
          //if so - conflict - need to resolve

          var timesStart = [];
          var timesStop = [];

          for (let i = 0; i < routines.length; i++) {

            timesStart.push(routines[i].timeStart);
            timesStop.push(routines[i].timeStop);
          }

          //Math.max.apply(null, timesStop)

          console.log(timesStart);
          console.log(timesStop);

          console.log(timesStart.sort());
          console.log(timesStop.sort());

          console.log("\n");



          for (let i = 0; i < routines.length; i++) {
            if (!checkSingleSanity(values, routines[i])) {
              return 0;
            }
          }
          return 1;
        }

        //Check if the inputs are valid
        function checkInputs(values) {

          //Check if a valid device selected
          if (typeof values.devID == "undefined") {
            //Tell the user to select a valid device
            alert("Please select a device");
            //Return and do not execute the rest of the function as there is an invalid input
            return 0;
          }

          //Check the starting time value - should only be a integer between 0 and 1000
          if ((!values.timeStart) || (values.timeStart < 0) || (values.timeStart > 1000)) {
            //Alert the user to select a valid time
            alert("Please enter a starting time between 0 and 1000 seconds");

            //Return and do not execute the rest of the function as there is an invalid input
            return 0;
          }

          //Check the stopping time value - should only be a integer between 0 and 1000
          if ((!values.timeStop) || (values.timeStop < 0) || (values.timeStop > 1000)) {
            //Alert the user to select a valid time
            alert("Please enter a stopping time between 0 and 1000 seconds");

            //Return and do not execute the rest of the function as there is an invalid input
            return 0;
          }

          //Check the start time is before the stop time
          if (values.timeStart > values.timeStop - 1) {
            //Alert the user to select a valid time
            alert("Please ensure that the starting time is less than the stopping time");

            //Return and do not execute the rest of the function as there is an invalid input
            return 0;
          }

          if (typeof values.devState == "undefined") {
            //Tell the user to select a valid device
            alert("Please select a state");
            //Return and do not execute the rest of the function as there is an invalid input
            return 0;
          }

          //Check inputs sanity
          if (!checkInputsSanity(values)) {
            return 0;
          }

          return 1;

        }

        //Generate timing JSON data from user input
        $(document).on("click", "button.genTiming", function (event) {

          //Get the value of the user inputs
          values = getInputs();

          //Check that the user input is valid
          if (checkInputs(values)) {

            //Create the JSON object
            var obj = { devID: values.devID, timeStart: values.timeStart, timeStop: values.timeStop, state: values.devState };

            //Convert the JSON object to a string
            //var myJSON = JSON.stringify(obj);

            routines.push(obj);

            //Append this to the page
            //$('<p>' + myJSON + '</p>').appendTo('#timings');

            console.log(JSON.stringify(routines));
          }
        });

        //Bind the device selection to the following handler - to adjust the state drop down
        $(document).on("change", "#devices_dropdown", function (event) {

          var devClass = $('select[id="devices_dropdown"] option:selected').attr('class');

          //Debugging, display the ID to be requested
          //alert($('select[id="devices_dropdown"] option:selected').attr('class'));

          $('#state').empty();

          switch (devClass) {
            case "perPump":
              $('#state').append('<option selected="true" disabled>Select State</option>');
              $('#state').append('<option class="1">On</option>');
              $('#state').append('<option class="0">Off</option>');
              $('#state').prop('selectedIndex', 0);
              break;

            case "solValve":
              $('#state').append('<option selected="true" disabled>Select State</option>');
              $('#state').append('<option class="1">On</option>');
              $('#state').append('<option class="0">Off</option>');
              $('#state').prop('selectedIndex', 0);
              break;

            case "sixValve":
              $('#state').append('<option selected="true" disabled>Select State</option>');
              $('#state').append('<option class="0">Position A</option>');
              $('#state').append('<option class="1">Position B</option>');
              $('#state').prop('selectedIndex', 0);
              break;

            default:
            // code block
          }
        });

        //Bind the routine selection to the following handler generate the visualisation
        $(document).on("change", "#routines_dropdown", function (event) {

          //Get the ID of the selected routine
          var selRoutineID = $('select[id="routines_dropdown"] option:selected').attr('class');

          //Debugging, display the ID to be requested
          //alert(selRoutineID);

          //Clear the previous visualisation bars
          $("#visualisation").empty();

          //Testing - use static json
          response = $.parseJSON(tstRoutines)

          //Get the devices on the system in a JSON format
          // $.getJSON("/routines.json", function (response) {

          //Loop through all of the routines in the file
          $.each(response, function (i, routines) {

            //If the routineID is the one that needs to be visualised
            if (selRoutineID == routines.routineID) {

              //Attempt to get the duration of the routine
              var duration = getDuration(JSON.stringify(routines.timings));

              //Check if failed - code non-zero
              if (duration.code) {
                //Alert that an error occurred
                alert("Error getting the duration of the routine");

                //Log specific error
                console.log(duration.msg);
              }

              //Loop through all of the timings in the selected routine, looking for the last stop time - I.E the duration of the whole routine
              $.each(routines.timings, function (i, timing) {

                //Attempt to get the device name from the deviceID
                var devName = getDeviceName(timing.devID);

                //Check if failed - code non-zero
                if (devName.code) {
                  //Alert that an error occurred
                  alert("Error getting device name");

                  //Log specific error
                  console.log(devName.msg);
                }

                //Calculate the width of the block in the figure, in %
                //Calculate the duration of the block
                var stepDur = timing.timeStop - timing.timeStart;

                //Convert this to the width of the block by multiplying by 100/duration
                var blockWidth = stepDur * (100 / duration.dur);


                //Create visualisation HTML span
                var rowHTML = '<div class="row"> <h6>' + devName.name + '</h6><div class="chart"><span style="width:' + blockWidth + '%;"class="block" title="' + timing.state + ' </span></div></div>">';


                //Create visualisation HTML span
                //var rowsHTML = '<div class="row"> <h6>' + devName.name + '</h6><div class="chart">' + spansHTML + '</div></div>">';



                //Create visualisation HTML span
                var spanHTML = '<span style="width:' + blockWidth + '%;"class="block" title="' + timing.state + '"</span>>';

                //Print out the routine timing data
                $(rowHTML).appendTo('#visualisation');

                //Print out the routine timing data
                $('<p> Device ID: ' + timing.devID + ', Device Name: ' + devName.name + ', Start time: ' + timing.timeStart + ', Stop Time: ' + timing.timeStop + ', State: ' + timing.state + '</p>').appendTo('#visualisation');
              });

              //Print out the last time found in the routine
              $('<p> Duration: ' + duration.dur + '</p>').appendTo('#timings');

              //Calculate item width per second
              var widthPerSec = 100.00 / duration.dur
              //Print out the last time found in the routine
              $('<p> Width per second: ' + widthPerSec + '</p>').appendTo('#timings');
            }
          });


          // });



          //Create timing visualisation

          //Fetch timings.json file/data
          //Parse data, looking for the largest time stop - this is 100% width scale.
          //For other steps, work out duration, and scale by the width scale
          //For steps not starting at time zero, add on previous width data to 


          //Visualisation
          // $('.value').each(function () {
          //   var text = $(this).text();
          //   $(this).parent().css('width', text);
          // });

          //$('.block').tooltip();
          //});

        });








        //Clear dropdown
        $('#devices_dropdown').empty();

        //Set default option as select device, and make it disabled
        $('#devices_dropdown').append('<option selected="true" disabled>Select Device</option>');
        $('#devices_dropdown').prop('selectedIndex', 0);

        var opHTML = '';

        response = $.parseJSON(tstDevices)
        //$.getJSON("/devices.json", function (response) {

        $.each(response, function (i, item) {
          opHTML += '<option id=' + item.devID + ' class =' + item.devType + '>' + item.devName + '</option>';
        });

        $('#devices_dropdown').append(opHTML);

      });
    </script>

  </div>
</body>

</html>